#!/bin/bash

# Cursor Auto-Update Script
# Automatically checks for the latest version and updates if needed

set -euo pipefail

# Configuration
INSTALL_DIR="$HOME/.local/cursor.app"
PACKAGE_JSON="$INSTALL_DIR/usr/share/cursor/resources/app/package.json"
GITHUB_README="https://raw.githubusercontent.com/oslook/cursor-ai-downloads/main/README.md"
TEMP_DIR="/tmp/cursor-update-$$"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

# Get current installed version
get_current_version() {
    if [[ -f "$PACKAGE_JSON" ]]; then
        version=$(grep -o '"version":\s*"[^"]*"' "$PACKAGE_JSON" | cut -d'"' -f4 || echo "0.0.0")
        echo "$version"
    else
        echo "0.0.0"
    fi
}

# Get latest version from GitHub
get_latest_version() {
    # Parse the README to find the first Linux x64 AppImage URL
    latest_info=$(curl -s "$GITHUB_README" | grep -oE 'https://downloads\.cursor\.com/[^"]*Cursor-[0-9]+\.[0-9]+\.[0-9]+-x86_64\.AppImage' | head -1)
    
    if [[ -n "$latest_info" ]]; then
        # Extract version from the URL
        version=$(echo "$latest_info" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
        echo "$version"
    else
        echo ""
    fi
}

# Get download URL for a specific version
get_download_url() {
    local version=$1
    
    # Get the download URL from GitHub README - escape dots in version for grep
    version_escaped=$(echo "$version" | sed 's/\./\\./g')
    download_url=$(curl -s "$GITHUB_README" | grep -oE "https://downloads\.cursor\.com/[^\"]*Cursor-${version_escaped}-x86_64\.AppImage" | head -1)
    
    if [[ -n "$download_url" ]]; then
        echo "$download_url"
    else
        # Fallback to standard URL pattern
        echo "https://download.cursor.sh/linux/appImage/x64/Cursor-${version}-x86_64.AppImage"
    fi
}

# Compare versions (returns 0 if v1 > v2)
version_gt() {
    test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
}

# Download Cursor
download_cursor() {
    local version=$1
    local download_url=$(get_download_url "$version")
    local appimage_file="$TEMP_DIR/Cursor-${version}-x86_64.AppImage"
    
    log_info "Downloading Cursor $version..."
    log_info "URL: $download_url"
    
    mkdir -p "$TEMP_DIR"
    
    if ! curl -L -o "$appimage_file" "$download_url" --progress-bar --silent; then
        log_error "Failed to download Cursor $version"
        return 1
    fi
    
    # Verify download
    if [[ ! -f "$appimage_file" ]] || [[ $(stat -c%s "$appimage_file") -lt 1000000 ]]; then
        log_error "Download failed or file is too small"
        return 1
    fi
    
    log_success "Download completed successfully"
}

# Install Cursor
install_cursor() {
    local appimage_file=$1
    
    log_info "Installing Cursor..."
    
    # Make executable
    chmod +x "$appimage_file"
    
    # Extract AppImage
    cd "$TEMP_DIR"
    log_info "Extracting AppImage..."
    if ! "$appimage_file" --appimage-extract > /dev/null 2>&1; then
        log_error "Failed to extract AppImage"
        return 1
    fi
    
    # Check if extraction was successful
    if [[ ! -d "squashfs-root" ]]; then
        log_error "Extraction failed - squashfs-root directory not found"
        return 1
    fi
    
    # Backup existing installation
    if [[ -d "$INSTALL_DIR" ]]; then
        log_info "Backing up existing installation..."
        rm -rf "$INSTALL_DIR.backup"
        mv "$INSTALL_DIR" "$INSTALL_DIR.backup"
    fi
    
    # Install new version
    mv squashfs-root "$INSTALL_DIR"
    
    # Clean up
    cd - > /dev/null
    rm -rf "$TEMP_DIR"
    
    log_success "Cursor installed successfully!"
}

# Create desktop entry
create_desktop_entry() {
    local desktop_file="$HOME/.local/share/applications/cursor.desktop"
    
    mkdir -p "$(dirname "$desktop_file")"
    cat > "$desktop_file" << EOF
[Desktop Entry]
Type=Application
Name=Cursor
Comment=AI-powered Code Editor
Exec=$INSTALL_DIR/AppRun %F
Icon=$INSTALL_DIR/co.anysphere.cursor.png
Categories=Development;TextEditor;IDE;
MimeType=text/plain;text/x-csrc;text/x-c++src;text/x-java;text/x-python;
StartupNotify=true
StartupWMClass=cursor
EOF
    
    chmod +x "$desktop_file"
    log_info "Desktop entry created/updated"
}

# Main script
main() {
    echo -e "${BLUE}╔═══════════════════════════════════╗${NC}"
    echo -e "${BLUE}║      Cursor Auto-Update Script    ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════╝${NC}"
    echo
    
    # Get current version
    log_info "Checking current version..."
    current_version=$(get_current_version)
    log_info "Current version: ${YELLOW}$current_version${NC}"
    
    # Get latest version
    log_info "Checking for updates..."
    latest_version=$(get_latest_version)
    
    if [[ -z "$latest_version" ]]; then
        log_error "Could not determine latest version from GitHub"
        exit 1
    fi
    
    log_info "Latest version:  ${YELLOW}$latest_version${NC}"
    
    # Compare versions
    if [[ "$current_version" == "$latest_version" ]]; then
        log_success "✓ You already have the latest version!"
        exit 0
    fi
    
    if [[ "$current_version" != "0.0.0" ]] && version_gt "$current_version" "$latest_version"; then
        log_warning "Your version ($current_version) is newer than the latest official release ($latest_version)"
        read -p "Do you want to downgrade? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 0
        fi
    fi
    
    # Download and install
    echo
    log_success "Update available: $current_version → $latest_version"
    read -p "Do you want to update now? (y/N): " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Update cancelled"
        exit 0
    fi
    
    # Download the new version
    download_cursor "$latest_version"
    download_status=$?
    
    if [[ $download_status -ne 0 ]]; then
        log_error "Download failed"
        exit 1
    fi
    
    # Set the AppImage file path
    appimage_file="$TEMP_DIR/Cursor-${latest_version}-x86_64.AppImage"
    
    if install_cursor "$appimage_file"; then
        create_desktop_entry
        echo
        log_success "✓ Cursor updated to version $latest_version"
        log_info "Installation location: $INSTALL_DIR"
        log_info "Run with: $INSTALL_DIR/AppRun"
        
        if [[ -d "$INSTALL_DIR.backup" ]]; then
            echo
            log_info "If you encounter issues, restore the backup with:"
            echo -e "  ${YELLOW}rm -rf $INSTALL_DIR && mv $INSTALL_DIR.backup $INSTALL_DIR${NC}"
        fi
    else
        log_error "Installation failed"
        
        # Restore backup if exists
        if [[ -d "$INSTALL_DIR.backup" ]]; then
            log_info "Restoring backup..."
            rm -rf "$INSTALL_DIR"
            mv "$INSTALL_DIR.backup" "$INSTALL_DIR"
            log_success "Backup restored"
        fi
        
        exit 1
    fi
}

# Cleanup on exit
cleanup() {
    rm -rf "$TEMP_DIR"
}

trap cleanup EXIT

# Check for --check flag (for automated checking)
if [[ "${1:-}" == "--check" ]]; then
    current=$(get_current_version)
    latest=$(get_latest_version)
    if [[ "$current" != "$latest" ]] && [[ -n "$latest" ]]; then
        echo "Update available: $current → $latest"
        exit 0
    else
        exit 1
    fi
fi

# Run main function
main "$@"
